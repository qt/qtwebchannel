<html>
    <head>
        <script>
            function exec(data, callback, type)
            {
                type = type || 'EXEC';
                var xhr = new XMLHttpRequest;
                xhr.open("POST", "../" + type, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState != 4 || xhr.status != 200)
                        return;
                    callback(xhr.responseText);
                };
                xhr.send(data);
            }

            function poll(id, callback)
            {
                exec(id, function(response) {
                    callback(response);
                    setTimeout(function() { poll(id, callback); }, 0);
                }, 'SUBSCRIBE');
            }

            window.addEventListener("message", function(event) {
                var data = JSON.parse(event.data);
                console.log("MESSAGE:", data);
                function callback(r) { window.parent.postMessage(JSON.stringify({ type: "callback", id: data.id, payload: r }), "*"); }
                if (data.type == "EXEC")
                    exec(data.payload, callback);
                else if (data.type == "SUBSCRIBE")
                    poll(data.id, callback);
            });
        </script>
    </head>
    <body>
    </body>
</html>
